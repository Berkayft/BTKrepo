

Proceedingsofthe2023InternationalConferenceonMachineLearningandCybernetics,9-11July,2023
SOLVINGTHEVRPUSINGTRANSFORMER-BASEDDEEPREINFORCEMENT
LEARNING
XUE-LIANREN
t
,2,AI-XIANG(ANDY)CHEN
t
,2*
ISchoolofStatisticsandMathematics,GuangdongUniversityofFinanceandEconomics,Guangzhou,China
2Institute
ofArtificialIntelligenceandDeepLearning,Guangzhou,China
E-MAIL:renxljy@163.com.cax413@163.com
lD
LI1
'"
r-,
N
m
o
.....
m
N
o
N
LJ"i
er
LI1
00
LI1
U
--'
~
u
<;
'"
o
.....
.....
a
.....
6
o
w
w
w
m
N
o
N
©
o
o
,...;
m
<J'>
'<,
m
N
0-
00
r-,
m
o
M
o
LI1
m
00
d,
r-,
'"
V1
U
"'"
'"
E
'"
..c
>-
u
-a
c
'"
eo
c
'E
'"
'"
--'
'"
c
£
u
ru
~
c
o
'"
u
c
e
~
c
o
u
'"
c
o
"'"
'"
c
~
c
m
N
o
N
Abstract:
TheVehicleRoutingProblem(VRP)isawell-knownNP-
hardproblem,andfindingfastandefficientalgorithmsforVRP
hasbeena
majorresearchfocusintheacademiccommunity.In
recentyears,theadvancementsindeepreinforcementlearning
haveprovidednewpossibilitiesforsolvingVRP.This
paper
proposesanovelapproachforsolvingVRPusinga
Transformer-baseddeepreinforcementlearningframework
withanencoder-decoderstructure.Theencoderutilizesa
TransformermodeltoencodetheVRPproblem,whilethe
decoderincorporatesthepositionalinformationofthenodes
thathavealreadybeenvisitedasinputandgeneratesasequence
ofnodestobevisitedasthe
outputsolution.Finally,theentire
modelistrainedusingreinforcementlearning.Experimental
resultsdemonstratethatthattheGAPvalueofourmodelin
CRP20hasdecreasedto0.705%,whichismorestable
thanother
modelsandhasamuchfastersolvingspeedthantheheuristic
model.
Keywords:
Transformer;Deeplearning;Reinforcementlearning;
Vehicleoptimizationproblem;Locationencoding
1.Introduction
Combinatorialoptimizationproblemsrefertofinding
theoptimalsolutionforaproblem'sobjectivefunctionunder
givenconstraintsbyconsideringvariouscombinations.The
VehicleRoutingProblem(VRP)isanNP-hardproblemthat
hasbeenahottopicinbothacademiaandindustryfordecades.
Itsobjectiveistoplanvehicleroutesfordeliveringgoodsto
afixednumber
ofcustomerswithoptimalefficiency.These
problemsaretypicallysolvedusingeitherexactalgorithmsor
approximationalgorithms.Exactalgorithmsaimtofindthe
exactsolutionwithinafinitetime,buttheirtimecomplexity
increasesastheproblemsizegrows.Ontheotherhand,
approximationalgorithmscanfindnear-optimalsolutionsin
979-8-3503-0378-0/23/$31.00©2023IEEE
365
areasonableamountoftimebutdonotguaranteetheoptimal
solution.
Traditionalalgorithmsplayacrucialroleinsolving
combinatorialoptimizationproblems.However,withthe
advancement
ofdeeplearning[1],researchershavestarted
exploringthecombination
ofdeepneuralnetworksand
reinforcementlearningalgorithmstosolvetheseproblems.In
thisapproach,deeplearningmodels,oftenbasedonencoder-
decoderarchitectures,areusedtorepresenttheproblemstate
andaction-valuefunctions,whilereinforcementlearning
algorithmsareemployedtolearntheoptimalpolicy.The
advantages
ofdeepreinforcementlearningmethodsliein
theirabilitytolearnproblem-solvingstrategiesdirectlyfrom
datathroughend-to-endlearning,withoutspecific
assumptionsormanualfeatureengineering.Theyalso
outperformmanyheuristicalgorithmsinterms
ofsolution
speed.However,thesemethodsrequirealargeamount
of
trainingdataandcomputationalresources,andthetraining
processistypicallytime-consuming.Moreover,duetothe
complexity
ofcombinatorialoptimizationproblems,thereis
stillsignificantroomforimprovementintheperformance
of
deepreinforcementlearningmethods.Inthisstudy,anew
modelalgorithmbasedontheTransformermodel[2]and
reinforcementlearningisproposedtosolvetheVRP.The
proposedmodelshowsimprovedconvergencespeedand
solutionaccuracy.
2.Related
work
In1985,Hopfieldetal.[3]pioneeredtheintegrationof
neuralnetworkswithcombinatorialoptimizationproblems
andsuccessfullyappliedneuralnetworkstosolvesmall-scale
travelingsalesmanproblems.However,itwasnotuntil2015
whenVinyalsetal.[4]introducedthePointerNetworkmodel,
whichopenedupnewpossibilitiesforusingneuralnetworks
totacklecombinatorialoptimizationproblems.Thismodel
Authorized licensed use limited to: ULAKBIM UASL - IZMIR YUKSEK TEKNOLOJI ENSTITUSU. Downloaded on November 02,2024 at 14:47:54 UTC from IEEE Xplore.  Restrictions apply. 

Proceedingsofthe2023InternationalConferenceonMachineLearningandCybernetics,9-11July,2023
FIGUREl.Networkstructure
3.1.Encoder
o~o~,mbedd,ng~\rrlJi·~~}b~I/o.-
p
~0.n,M;'---~Come,;;vectorSelect1
o0"h
o
Iayef.L--...l
l
~j)oode
j
d\!\~:;,
o0~)~.h,'PE~
it'."v.""'''&vpd...,.",d".lle<od"~
thenextnodetobechosenrepresentstheactiontobetaken.
Thenegative
ofthesumofpathlengthstovisiteachnode,
accordingtothepolicy
71:,isusedasthereward.Here,the
symbol
11·llzrepresentsthelznorm,andtheobjectiveisto
maximizetherewardfunction.
Tkm
R=-L(nls)=-IIIIXnCi)-X
nCi
+
1
)
liz(1)
j=li=l
Themodelproposedinthispaperisbasedonmodifying
thedecoder
oftheTransformermodel.Themodelstructureis
showninFigureI.Thefollowingsectionwillprovidea
detailedintroductiontothemodelpresentedinthispaper.
(2)
i=0
DecoderEncoder
BasedontheencoderdesignusedintheTransformer
architecturebyVaswanietal.[2],thispaperadoptsasimilar
encoder.Toensurethatthegeneratednodeembeddingsare
notaffectedbytheinputorder,positionalencodingisno
longerusedintheencoder.Theinputisrepresentedas
=
{xi,dj,i=0,1,2•...n,j=1,2,...•n}.
Giventheinputfeatures,theEncoderperformsalinear
mappingusinglearnedparameters
W
x
andb
x
toobtainthe
initialnodeembeddings
H~O).Todifferentiatebetweenthe
warehousenodeandthecustomernodes,separateparameters
W
xo
andb
xo
areusedtocalculatetheinitialnode
embeddingvector
H~O).
(0)_{WxoX
O
+»;
H.-~
IW
x
[Xi,dd+b
x
i=1,...,n
Then,Nlayersofthesameattentionmoduleareusedto
updatethenodeembeddingvectors.LetH~l)representthe
nodeembeddingvectorgeneratedbylayer
1E[L,...,N},
whereN=3isthenumberofattentionmodulelayers,and
thenodeembeddingdimensionis128.Eachattentionmodule
layerconsistsoftwosub-layers:multi-headself-attentionand
afullyconnectedlayer.Bothsub-layersemployresidual
connections,whichincludeaskipconnectionandbatch
normalization(BN).Theimplementationprocessisas
follows:
3.VRPSolutionMethodBasedonDeep
ReinforcementLearning
proposedanovelencoder-decoderstructurebasedon
sequence-to-sequence(seq2seq)modelsandemployed
gradientoptimizationmethodsforend-to-endtraining,
resultinginefficienttrainingandstronggeneralization
capabilities.However,thesupervisedtraining
ofthismodelis
sensitivetothequantityandquality
ofthetrainingsamples,
makingittime-consumingtosolvelarge-scalecombinatorial
optimizationproblems.
Belloetal.[5]madeimprovementstothe
aforementionedapproachbymodelingthecombinatorial
optimizationproblemasaMarkovprocess,usingthe
objectivefunctionastherewardsignal,andtrainingitwith
theREINFORCEalgorithm[2].InspiredbytheTransformer
model,Deudonetal.[6]adoptedasimilarencoderstructure
andusedembeddings
ofthethreemostrecentselectednodes
asqueryvectorsinthedecoder.Theycontinuedtrainingthe
modelusingreinforcementlearningalgorithmsandoptimized
theinitialsolutionthroughlocalsearch.Thismethod[6]not
onlyimprovedthequality
ofthesolutionsbutalsoreduced
thecomplexity
ofthemodel.Buildinguponthis,KOOLetal.
[7]extendedthemodelbyconsideringthenodesselectedin
thefirststepandthetwomostrecentstepstomakedecisions
forthenextstep.TheyalsodesignedamoreefficientRollout
baselinemethodtotrainthemodel,enablingittosolve
variouscombinatorialoptimizationproblems.Additionally,
Bressonetal.[8]introducedpositionalencodinginthe
decoder,incorporatinginformationaboutthevisitednodesas
inputforthenextstep.Theirmodelachievedhigheraccuracy
comparedtomanyheuristicmethods.
Thispaperisbasedondeepreinforcementlearningand
improvestheTransformermodeltosolvetheCVRP
(CapacitatedVehicleRoutingProblem).Givenaset
X=
{Xi,i=0,1,2,...n},wherei=0representsthewarehouse
coordinatesandtherestare
customer.
coordinates,thevehiclecapacityisdenotedasD,andthe
demandforeachcustomernodeis0
<d
j
~D.Foranyroute
k,LjETkd
j
~D.Withoutlossofgenerality,thispaper
~d·
normalizesthecustomerdemandsasd
j
=~andnormalizes
Dasl5.Theinputtothemodelincludesnodecoordinates
andcustomerdemandss
={Xi,d
j
,
i=0.1,2,...n.]=
1,2,...,n},anditgeneratestheoutputorderttforvisiting
customernodes.TheCVRPismodeledasaMarkovdecision
process,wherethealreadyvisitedcustomersequenceandthe
remainingvehiclecapacityserveasthecurrentstates,and
366
Authorized licensed use limited to: ULAKBIM UASL - IZMIR YUKSEK TEKNOLOJI ENSTITUSU. Downloaded on November 02,2024 at 14:47:54 UTC from IEEE Xplore.  Restrictions apply. 

Proceedingsofthe2023InternationalConferenceonMachineLearningandCybernetics,9-11July,2023
(8)
(13)
Hi=BN
I
(HF-l)+MHAl(H~I-l)))(3)
HF)=BNI(Hi+FFI(H
i))
(4)
ThetermMHArepresentsMulti-HeadAttention,which
consistsof8stackedself-attentionmechanisms,i.e.,H=8,
withadimensionofd:=16.FFreferstoafullyconnected
layer,composedoftwofullyconnectedneuralnetworklayers
andoneReLUactivationlayer,withadimensionof512.
GiventhequeryvectorQI,h=Wd,hH(l-l),keyvector
K.l,h=w:KI,hH(l-l)andvaluevectorVl,h=Itv.vl,hH(l-l)The
}',
parametersWd,h,Wi,h,andWJ,harealltrainable
parameters.wecanimplementthemulti-headattention
mechanismasfollows:
Q!,hK.I,h
T
Al,h=sOftmax(uinVI,h=softmax(lJi)Vl,h(5)
H=8
MHA(H
I)
=LW~AI,h(6)
h=l
Finally,byperformingcomputationsthroughthe
encoder,weobtainthefinalnodeembeddingshfN).The
graphaggregationembeddinghfN)isthenobtainedby
takingtheaverageofthefinalnodeembeddings,represented
asheN)=~If-lhfN).
n-
3.2.Decoder
Thedecodingprocessisasequentialprocesswhereone
customerisvisitedatatime,andtheoutputisasequenceof
nodesrepresentingtheorderofvisitation.Thedepotnodecan
bevisitedmultipletimes.Assumingwehavealreadyvisited
tcustomers,weaimtopredictthenextnodetobevisited.The
decodingprocessconsistsofthefollowingfoursteps:
Thedecodingstartsfromtheencodingofthepreviously
visitedcityit.
H
ene
=[h
ene
h
ene
h
ene]
tt
1
't
z
I•••,t
H,=Hfne+PEt
ht=o=h
o
Here,PEtrepresentsthetraditionalpositionalencoding,
whichisusedtosortthealreadyvisitedcustomernodes.
f'in(;,)jiseven
p~1en,Cooo~oo:)jisodd(7)
Theself-attentionmechanismisusedtoprocessthe
alreadyvisitednodesthathaveundergonepositional
encoding,resultinginthepositionalencodednode
367
embeddingsHfe.Here,TheparametersW
q,
Wkand~are
trainableparametersinthisstep.
(
QK
IT
)
H
pe
=softmax--Vi
t.,j(j
Q=HtW
q
K
l
=wnew,rVi=wnewJ(9)
Decoding-Step3:Inthisstage,multi-headattentionis
usedtoobtainthefinaloutputHfee.Thecontextvectorsused
inthissteparethepositionalencodednodeembeddingsh~e
ofthepreviouslyvisitedcustomernodesandtheremaining
vehiclecapacityD
t
.
Thecontextatt=1includesthe
encodedinformationofthedepot(warehouse)andthe
maximumvehiclecapacity.
(
QKhT)
ht
ee
=softmax(?;-aV
h
(10)
Q(C)=H(e)W
q
h
K
h
=Henew/:V
h
=HeneWvh(11)
H={[h
ene,
h~e,Dt]t>1
(C)[hene,hgne,Dt]t=1(12)
Finally,theself-attentionmechanismisusedtoobtain
theprobabilitydistributionPtforthedepotnodeandthe
unvisitedcustomernodesatthecurrenttimestep.Basedon
thisprobabilitydistribution,thenextnodetobevisitedis
selected,andthedemandofthevisitedcustomernodeisset
tozero.Inthisstep,maskingisappliedasfollows:masking
thecustomernodeswithzerodemand,maskingallcustomer
nodesiftheremainingvehicleloadisexactly0,maskingthe
customerswhosedemandexceedsthecurrentvehicleload,
andsettingthelogarithmofprobabilitytonegativeinfinity
forinfeasiblesolutions.
u(e)={c_'ootanh(Qa;;T)ifj~itt
otherwise
QO=Hfeew
q
o
KO=wnew~(14)
Pt=softmax(u(e))(15)
Here,WqOandW~aretrainableparameters,andCisa
hyperparameterwithavalueof10.
3.3.REINFORCEwithgreedyrolloutbaseline
Givenaninstances,theencoder-decodermodel
generatesaprobabilitydistribution,fromwhichwecan
sampleasolutionnls.Totrainthemodel,wedefinealoss
functionasfollows:
Givenaninstance(currentstate)s,theencoder-decoder
producesaprobabilitydistributionPe(rr]s),fromwhichwe
cansampleasolutionrrlsforstates.Totrainthemodel,a
Authorized licensed use limited to: ULAKBIM UASL - IZMIR YUKSEK TEKNOLOJI ENSTITUSU. Downloaded on November 02,2024 at 14:47:54 UTC from IEEE Xplore.  Restrictions apply. 

Proceedingsofthe2023InternationalConferenceonMachineLearningandCybernetics,9-11July,2023
lossfunctionisdefined:
L(8Is)=IEpe(rcIS)L(rc)(16)
ThemodelinthispaperutilizestheREINFORCE
algorithm,whichcombinesaRolloutbaseline,toupdatethe
parametersthroughgradientdescent.
\7L(8Is)
=IE
pe
(TCIS)[L(rc)-b(s))\7logPe(rcls)](17)
Inthisapproach,themodelL(rc)employsarandom
samplingstrategytoselectactions,whilethebaselineb(s)
usesagreedyalgorithmtoselectactions.Whenthepath
lengthL(rc)ofthepolicyttislowerthanthatofthebaseline
b(s),thepolicyofL(rc)isupdatedtothenewbaseline
policy.
4.Experiment
Theimplementationofthenetworkmodel,algorithms,
andtraininginthisstudywasdoneusingthePyTorch1.1.7
deeplearningframeworkinaPython3.8environment.The
trainingprocessutilizedaGPU,specificallytheNVIDIA
RTX3060,toacceleratecomputations.TheCRP20and
CRP50probleminstanceswerethefocus
ofthetrainingin
thisstudy.
4.1.EvaluationMetrics
Therelativeerrorbetweentheoptimalsolutionlength
I
obtainedusingGurobiandLKH3andtheapproximateroute
lengthL(rcls)generatedbythemodelinthisstudywasused
asthecriterionforassessment.
L(rcls)-
I(18)
GAP=_
L
4.2.DatasetandSettings
Consideringtherandomnessinthedistribution
of
customernodesinreal-lifescenarios,thenodecoordinatesin
thispaper'sdatasetaregeneratedrandomlyfollowinga
uniformdistribution.Thenumberofcustomernodesissetto
20and50,respectively.Thecustomerdemandsareuniformly
sampledfromthediscretedata{I,2,3,...,9},where
D
20
=
30andD
SO
=40.Thetrainingisconductedfor100epochs
onthevehicleroutingoptimizationproblemwith20and50
customernodes.ForCRP20,eachepochconsistsof2500
batches,witheachbatchcontaining512instances,resulting
inatotal
of1,280,000probleminstances.ForVRP50,since
thedepotisvisitedmultipletimes,thesolutionlengthis
greaterthann,requiringmorememory.Therefore,when
n=
50,eachbatchuses256instancedata.TheAdamoptimizeris
utilizedtoupdateEquation(18)throughgradientdescent,
withalearningratesetto0.0001.Therandomnumber
generatorseedissettoseed=1234.
TABLE1.Myexperimentalresultsvs.baselines.Thegap%isw.r.t.thebestvalueacrossallmethods.
CRP20
method
ou.GAP(%)
Gurobi
6.100.00%
LKH36.14
0.58%
RL
6.598.03%
RL(beam10)6.404.92%
RandomCW6.8111.64%
RandomSweep7.0816.07%
AM6.404.97%
our6.1430.705%
time
2h
Is
2s
CRP50
Ob}.GAP(%)
10.38
0.00%
11.39
9.78%
11.157.46%
12.2518.07%
12.9624.91%
10.985.86%
10.854.53%
time
7h
3s
8s
4.3.ExperimentalResultsandAnalysis
Usingthepathlengthsobtainedbytheheuristic
algorithmoptimizersGurobiandLKH3asthebenchmark,the
optimalrelativeerrorGAPiscalculatedbasedonEquation
368
(18).Comparingwithothersolvingmethods,theproposed
modelachievesalowerGAP.Table1presentsthe
experimentalresults
oftheproposedmodelandothermodels
onthesametestsets
ofCRP20andCRP50probleminstances.
ItcanbeobservedthattheGAPvaluesarereducedto0.705%
forCRP20and4.53%forCRP50.Comparedwithheuristic
Authorized licensed use limited to: ULAKBIM UASL - IZMIR YUKSEK TEKNOLOJI ENSTITUSU. Downloaded on November 02,2024 at 14:47:54 UTC from IEEE Xplore.  Restrictions apply. 

Proceedingsofthe2023InternationalConferenceonMachineLearningandCybernetics,9-11July,2023
5.Conclusion
FIGURE2.Held-outvalidationsetoptimalitygapasafunctionofthe
number
ofperiodsfortheattentionmodel(AM)andmymethodwithsame
baselines.
Theproposedmethodinthispaperforsolvingthe
vehicleroutingoptimizationproblemincorporatespositional
encoding,whichtakesintoaccountthepositionalinformation
ofnodesinthesequence,effectivelyextractingthelocation
information
ofvisitednodesduringthedecodingprocess.
Experimentalresultsdemonstratethatthemodelapproaches
theoptimalsolutionsobtainedbyheuristicalgorithms,
acceleratesthesolvingspeed,andenhancesthestability
ofthe
model.However,themodelproposedinthispaperfocuses
solelyontraditionalvehicleroutingoptimizationproblems.
Inreality,vehicleoptimizationproblemsofteninvolve
multipleobjectivesandconstraints.Therefore,researchon
usingdeepreinforcementlearningtosolvemulti-objective
andmulti-constraintvehicleoptimizationproblemsisan
importantdirectiontoexploreinthefuture.
algorithms,theproposedmodelprovidessolutionsthatare
veryclosetotheheuristicsolutionsaftertraining.
Additionally,theproposedmodelismuchfasterthanthe
heuristicmodels,requiringonly2secondstoobtainsolutions
forthecorrespondinginstancesaftertraining.
Figure2showstheoptimizationcurvesofKool'smodel
andtheproposedmodel.Thecurverepresentstheminimum
pathlengthsobtainedbythemodelstrainedforeachroundon
thesametestset
of10,000CRP20instances.Itcanbeseen
thatduringthetrainingprocess,Kool'smodelachievesa
minimumpathlength
of6.328onthetestset,whilethe
proposedmodelachievesaminimumpathlength
of6.143.
Throughoutthetrainingprocess,theproposedmodel
consistentlyoutperformsKool'smodelinterms
oftestresults
anddemonstratesgreaterstability.Furthermore,bymodifying
theinputdata,theproposedmodelcanalsobeappliedtoother
combinatorialoptimizationproblemssuchasTSPandOP.
References
Acknowledgements
[1]Aixiangchen.Deeplearning.TsinghuaUniversity
press.2020
[2]VASWANIA,SHAZEERN,PARMARN,etal.
Attentionisallyouneed[C]//Advancesinneural
informationprocessingsystems.2017:5998-6008.
[3]JohnJHopfieldandDavidWTank."Neural"
computationofdecisionsinoptimizationproblems.
Biologicalcybernetics,52(3):141
-152,1985.
[4]OriolVinyals,MeireFortunato,andNavdeepJaitly.
Pointernetworks.InAdvancesinNeuralInformation
ProcessingSystems,pp.2692-2700,2015.
[5]BelloI,PhamH,Le
QV,NorouziM,BengioS.Neural
combinatorialoptimizationwithreinforcementlearning.
In:5thInternationalConferenceonLearning
Representations,ICLR2017-WorkshopTrack
Proceedings,2019.
[6]DeudonM,CournutP,LacosteA,AdulyasakY,
RousseauLM.Learningheuristicsforthetspbypolicy
gradient.In:InternationalConferenceontheIntegration
ofConstraintProgramming,ArtificialIntelligence,and
OperationsResearch,Springer,2018.170-181.
[7]KOOLW,VANHOOFH,WELLINGM.Attention,
learntosolveroutingproblems[J].arXiv:1803.08475,
2018.
[8]BressonX,LaurentT.TheTransformerNetworkforthe
TravelingSalesmanProblem[J].arXiv:2103.03012,
2021.
[9]DaiH,KhalilEB,ZhangY,DilkinaB,Song
L.Learning
combinatorialoptimizationalgorithmsovergraphs.In:
AdvancesinNeuralInformationProcessingSystems,
2017.6348-6358.
[10]GurobiOptimization,LLC.Gurobioptimizerreference
manual,2018.URLhttp://www.gurobi.com.
[11]KeldHelsgaun.AnextensionoftheLin-Kernighan-
HelsgaunTSPsolverforconstrainedtravelingsalesman
andvehicleroutingproblems:Technicalreport.2017.
ThispaperispartiallysupportedbyGraduateCourse
ConstructionProject"ModemMultivariateStatistical
Analysis(EnglishCourse)"atGuangdongUniversity
of
FinanceandEconomics,ChineseNationalOfficefor
PhilosophyandSocialSciences(19FTID003),andNational
BureauofStatistics
ofChina(2016LY64).
801004060
epoch
20a
,,
-our-
---
Kool
--~
"l.
"III,
I1-
1
--jill-I,I
IIll/"I','~.-
~tV'~;,I,~.~1tj•1\i',~;ll:':
\-,11-1\,t-~-f~1-I-'~/_rJ-~'-I~~
W~I"..A1!..:A'!AI'"
v-ytYVVvyr-w
6.5
7.5
8.0
--'
7.0
369
Authorized licensed use limited to: ULAKBIM UASL - IZMIR YUKSEK TEKNOLOJI ENSTITUSU. Downloaded on November 02,2024 at 14:47:54 UTC from IEEE Xplore.  Restrictions apply. 